<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Ledger AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div class="container">

    <header>
        <h1>
            <svg class="logo-icon" width="32" height="32" viewBox="0 0 32 32" fill="none">
                <rect width="32" height="32" rx="6" fill="currentColor"/>
                <text x="16" y="22" text-anchor="middle" fill="white" font-size="18" font-weight="bold">M</text>
            </svg>
            M-Ledger AI
        </h1>
        <button class="theme-toggle" id="theme_toggle">
            <span class="sun-icon">‚òÄÔ∏è</span>
            <span class="moon-icon">üåô</span>
        </button>
    </header>

   <section class="upload-section">
    <h2>Upload Statement</h2>
    <form id="upload_form" class="upload-form">
        <div class="file-input-wrapper">
            <input type="file" name="statement" id="statement" required accept=".pdf">
            <label for="statement" class="file-label">
                <span class="file-icon"></span>
                <span class="file-text" id="file_text">Choose File</span>
            </label>
            <input type="password" name="pdf_password" placeholder="Password (if any)" class="password-input">
        </div>
        <button type="submit" class="btn btn-primary">Upload Statement</button>
    </form>
    <p id="upload_message" style="margin-top:10px;"></p>
</section>


    <section class="summary-section">
        <h2>Financial Summary</h2>
        <div class="summary-grid">
            <div class="summary-card income-card">
                <p class="summary-label">Total Income</p>
                <p class="summary-value">KES <span id="income">{{ income|default(0)|format_number }}</span></p>
            </div>
            <div class="summary-card expense-card">
                <p class="summary-label">Total Expenses</p>
                <p class="summary-value">KES <span id="expenses">{{ expenses|default(0)|format_number }}</span></p>
            </div>
            <div class="summary-card charges-card">
                <p class="summary-label">Transaction Charges</p>
                <p class="summary-value">KES <span id="charges">{{ charges|default(0)|format_number }}</span></p>
            </div>
            <div class="summary-card balance-card">
                <p class="summary-label">Current Balance</p>
                <p class="summary-value">KES <span id="balance">{{ balance|default(0)|format_number }}</span></p>
            </div>
        </div>
    </section>

  
    <section class="filter-section">
        <h2>Filter Transactions</h2>
        <div class="filter-controls">
            <div class="form-group">
                <label for="type_filter">Transaction Type</label>
                <select id="type_filter" class="form-select">
                    <option value="all">All</option>
                    <option value="income">Income Only</option>
                    <option value="expense">Expense Only</option>
                    <option value="charge">Charges Only</option>
                </select>
            </div>
            <div class="form-group">
                <label for="amount_filter">Amount Filter</label>
                <select id="amount_filter" class="form-select">
                    <option value="none">None</option>
                    <option value="max">Maximum</option>
                    <option value="min">Minimum</option>
                </select>
            </div>
            <div class="form-group">
                <label for="timeline_filter">Timeline</label>
                <div>
                    <input type="date" id="start_date" class="form-input" placeholder="Start Date">
                    <input type="date" id="end_date" class="form-input" placeholder="End Date">
                </div>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" id="apply_filters">Apply Filters</button>
            </div>
            <div class="form-group">
                <button class="btn btn-secondary" id="download_pdf">Download PDF</button>
            </div>
        </div>
    </section>


    <section class="table-section">
        <h2>Transaction History</h2>
        <div class="table-wrapper">
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Details</th>
                        <th>Type</th>
                        <th>Paid In</th>
                        <th>Paid Out</th>
                        <th>Charges</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody id="tx_body">
                    {% if transactions %}
                        {% for t in transactions %}
                        <tr>
                            <td>{{ t.date }}</td>
                            <td>{{ t.details }}</td>
                            <td>
                                {% if t.category == "charge" %}<span class="badge badge-charge">Charge</span>
                                {% elif t.category == "income" %}<span class="badge badge-income">Income</span>
                                {% elif t.category == "expense" %}<span class="badge badge-expense">Expense</span>
                                {% else %}<span class="badge">-</span>{% endif %}
                            </td>
                            <td>{% if t.category == "income" %}{{ t.amount|format_number }}{% else %}0{% endif %}</td>
                            <td>{% if t.category == "expense" %}{{ t.amount|format_number }}{% else %}0{% endif %}</td>
                            <td>{% if t.category == "charge" %}{{ t.amount|format_number }}{% else %}0{% endif %}</td>
                            <td>{{ t.balance|format_number if t.balance else '-' }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr id="no_transactions">
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                No transactions to display. Upload an M-Pesa statement to get started.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="pagination">
            <button class="pagination-btn" id="prev_page" disabled>Previous</button>
            <span class="pagination-info" id="page_info">Page 1 of 1</span>
            <button class="pagination-btn" id="next_page" disabled>Next</button>
        </div>
    </section>

    <section class="ai-chat-section">
        <h2>Ask AI about your finances</h2>
        <div class="ai-chat-messages" id="ai_chat_messages">
            <div class="ai-chat-message bot">Hello! I'm your M-Ledger AI assistant. Upload a statement and ask me questions about your finances.</div>
        </div>
        <form id="ai_chat_form" class="ai-chat-form">
            <input type="text" id="ai_chat_input" placeholder="Type your question...">
            <button type="submit">Send</button>
        </form>
    </section>

</div>

<script>
const themeToggle = document.getElementById('theme_toggle');
themeToggle.addEventListener('click', () => {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
});

window.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    document.getElementById('statement').addEventListener('change', function(e) {
        const fileName = e.target.files[0] ? e.target.files[0].name : 'Choose File';
        document.getElementById('file_text').textContent = fileName;
    });
});

// Upload form handling
$('#upload_form').submit(function(e){
    e.preventDefault();
    
    const form = $(this);
    const formData = new FormData(form[0]);
    const fileInput = $('#statement')[0];
    
    if (!fileInput.files[0]) {
        $('#upload_message').html('<div class="alert alert-warning">Please select a PDF file.</div>');
        return;
    }
    
    $('#upload_message').html('<div class="alert alert-info">Uploading and processing PDF... Please wait.</div>');
    
    $.ajax({
        url: '/',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            // Create a temporary div to parse the response
            const tempDiv = $('<div>').html(response);
            const newContent = tempDiv.find('.container').html();
            
            // Update the page content
            $('.container').html(newContent);
            
            // Re-initialize event handlers
            initializeEventHandlers();
            
            // Show success message
            $('#upload_message').html('<div class="alert alert-success">Statement processed successfully! Reloading data...</div>');
            
            // Force page reload after 2 seconds to ensure all data is fresh
            setTimeout(() => {
                location.reload();
            }, 2000);
        },
        error: function(xhr) {
            let errorMsg = 'Upload failed. ';
            if (xhr.responseText) {
                const tempDiv = $('<div>').html(xhr.responseText);
                const error = tempDiv.find('.alert, #upload_message').text() || xhr.responseText;
                errorMsg += error.substring(0, 200);
            }
            $('#upload_message').html('<div class="alert alert-danger">' + errorMsg + '</div>');
        }
    });
});

// Initialize all event handlers
function initializeEventHandlers() {
    // Re-attach all event handlers here
    $('#ai_chat_form').off('submit').on('submit', function(e){
        e.preventDefault();
        const msg = $('#ai_chat_input').val().trim();
        if(!msg) return;
        
        $('#ai_chat_messages').append('<div class="ai-chat-message user">' + msg + '</div>');
        $('#ai_chat_input').val('');
        
        $('#ai_chat_messages').append('<div class="ai-chat-message bot loading">Thinking...</div>');
        $('#ai_chat_messages').scrollTop($('#ai_chat_messages')[0].scrollHeight);
        
        $.post("/ai_chat", { question: msg }, function(data){
            $('.ai-chat-message.bot.loading').last().remove();
            $('#ai_chat_messages').append('<div class="ai-chat-message bot">' + (data.answer || "No response from AI") + '</div>');
            $('#ai_chat_messages').scrollTop($('#ai_chat_messages')[0].scrollHeight);
        }).fail(function(){
            $('.ai-chat-message.bot.loading').last().remove();
            $('#ai_chat_messages').append('<div class="ai-chat-message bot">Failed to get AI response. Please try again.</div>');
            $('#ai_chat_messages').scrollTop($('#ai_chat_messages')[0].scrollHeight);
        });
    });
    
    // Re-attach other handlers...
    $('#apply_filters').off('click').on('click', applyFilters);
    $('#download_pdf').off('click').on('click', downloadPDF);
}

// Initialize on page load
$(document).ready(function() {
    initializeEventHandlers();
    updatePagination();
    
    // File input change handler
    $('#statement').on('change', function(e) {
        const fileName = e.target.files[0] ? e.target.files[0].name : 'Choose File';
        $('#file_text').text(fileName);
    });
});

$('#ai_chat_form').submit(function(e){
    e.preventDefault();
    const msg = $('#ai_chat_input').val().trim();
    if(!msg) return;
    
   
    $('#ai_chat_messages').append('<div class="ai-chat-message user">' + msg + '</div>');
    $('#ai_chat_input').val('');
    
    $('#ai_chat_messages').append('<div class="ai-chat-message bot loading">Thinking...</div>');
  
    $('#ai_chat_messages').scrollTop($('#ai_chat_messages')[0].scrollHeight);
    
    $.post("/ai_chat", { question: msg }, function(data){
        $('.ai-chat-message.bot.loading').last().remove();
        $('#ai_chat_messages').append('<div class="ai-chat-message bot">' + (data.answer || "No response from AI") + '</div>');
        $('#ai_chat_messages').scrollTop($('#ai_chat_messages')[0].scrollHeight);
    }).fail(function(){
        $('.ai-chat-message.bot.loading').last().remove();
        $('#ai_chat_messages').append('<div class="ai-chat-message bot">Failed to get AI response. Please try again.</div>');
        $('#ai_chat_messages').scrollTop($('#ai_chat_messages')[0].scrollHeight);
    });
});

-
$('#apply_filters').click(function(){
    const type_filter = $('#type_filter').val();
    const amount_filter = $('#amount_filter').val();
    const start_date = $('#start_date').val();
    const end_date = $('#end_date').val();
    
  
    $('#tx_body').html('<tr><td colspan="7" style="text-align: center; padding: 20px;">Applying filters...</td></tr>');

    $.ajax({
        url: "/filter_transactions",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
            type_filter: type_filter,
            amount_filter: amount_filter,
            start_date: start_date,
            end_date: end_date
        }),
        success: function(data){
            const tbody = $('#tx_body');
            tbody.empty();
            
            if(data.transactions && data.transactions.length > 0) {
                data.transactions.forEach(t => {
                    const badge = t.category === "charge" ? '<span class="badge badge-charge">Charge</span>' :
                                  t.category === "income" ? '<span class="badge badge-income">Income</span>' :
                                  t.category === "expense" ? '<span class="badge badge-expense">Expense</span>' :
                                  '<span class="badge">-</span>';
                    
                    const paidIn = t.category === "income" ? t.amount : 0;
                    const paidOut = t.category === "expense" ? t.amount : 0;
                    const charges = t.category === "charge" ? t.amount : 0;
                    const balance = t.balance ? t.balance : '-';
                    
                    tbody.append(`
                        <tr>
                            <td>${t.date}</td>
                            <td>${t.details}</td>
                            <td>${badge}</td>
                            <td>${paidIn}</td>
                            <td>${paidOut}</td>
                            <td>${charges}</td>
                            <td>${balance}</td>
                        </tr>
                    `);
                });
            } else {
                tbody.append('<tr><td colspan="7" style="text-align: center; padding: 40px;">No transactions match your filters.</td></tr>');
            }
        },
        error: function(){
            alert("Failed to apply filters. Please try again.");
            location.reload(); 
        }
    });
});


$('#download_pdf').click(function(){
    $.ajax({
        url: "/download_pdf",
        type: "GET",
        xhrFields: {
            responseType: 'blob'
        },
        success: function(data){
            const url = window.URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'M-Ledger_Report.pdf';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        },
        error: function(){
            alert("Failed to generate PDF report. Please try again.");
        }
    });
});


let currentPage = 1;
const transactionsPerPage = 20;

function updatePagination() {
    const totalRows = $('#tx_body tr').length;
    const totalPages = Math.ceil(totalRows / transactionsPerPage);
    
    $('#page_info').text(`Page ${currentPage} of ${totalPages}`);
    $('#prev_page').prop('disabled', currentPage === 1);
    $('#next_page').prop('disabled', currentPage === totalPages || totalPages === 0);

    $('#tx_body tr').each(function(index) {
        $(this).toggle(index >= (currentPage - 1) * transactionsPerPage && index < currentPage * transactionsPerPage);
    });
}

$('#prev_page').click(function() {
    if(currentPage > 1) {
        currentPage--;
        updatePagination();
    }
});

$('#next_page').click(function() {
    const totalRows = $('#tx_body tr').length;
    const totalPages = Math.ceil(totalRows / transactionsPerPage);
    
    if(currentPage < totalPages) {
        currentPage++;
        updatePagination();
    }
});


$(document).ready(function() {
    updatePagination();
});
</script>

</body>
</html>